<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign with Freighter - Public Key</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .method-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .method-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .method-desc {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        .output {
            margin-top: 20px;
            padding: 20px;
            background: #2d2d2d;
            color: #f8f8f2;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        .output.show {
            display: block;
        }
        .success { color: #50fa7b; }
        .error { color: #ff5555; }
        .info { color: #8be9fd; }
        .warning { color: #ffb86c; }
        .key-display {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-fast {
            background: #d4edda;
            color: #155724;
        }
        .badge-secure {
            background: #cce5ff;
            color: #004085;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Sign Wallet Connection</h1>
        <p class="subtitle">Choose your connection method</p>
        
        <!-- Method 1: Quick Connect -->
        <div class="method-section">
            <div class="method-title">
                <span>‚ö°</span>
                <span>Quick Connect</span>
                <span class="badge badge-fast">FASTEST</span>
            </div>
            <div class="method-desc">
                Simply retrieves your public key from Freighter. No signature required. 
                Perfect for viewing data and creating predictions.
            </div>
            <button onclick="quickConnect()">‚ö° Quick Connect</button>
        </div>
        
        <!-- Method 2: Signed Connect -->
        <div class="method-section">
            <div class="method-title">
                <span>üîê</span>
                <span>Signed Connect (Verified)</span>
                <span class="badge badge-secure">MOST SECURE</span>
            </div>
            <div class="method-desc">
                Retrieves your public key AND asks you to sign a message to prove ownership.
                Provides cryptographic proof that you control the wallet.
            </div>
            <button onclick="signedConnect()">üîê Connect with Signature</button>
        </div>
        
        <!-- Output Area -->
        <div id="output" class="output"></div>
    </div>

    <script>
        const output = document.getElementById('output');
        let freighterApi;
        
        // Initialize Freighter API
        window.addEventListener('load', () => {
            freighterApi = window.freighterApi || window.freighter;
            if (!freighterApi) {
                log('‚ùå Freighter not detected. Please install Freighter extension.', 'error');
                log('Download: https://www.freighter.app/', 'info');
            } else {
                log('‚úÖ Freighter API detected', 'success');
            }
        });
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${message}\n`;
            output.innerHTML += `<span class="${type}">${line}</span>`;
            output.classList.add('show');
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }
        
        function clearOutput() {
            output.innerHTML = '';
            output.classList.remove('show');
        }
        
        async function quickConnect() {
            clearOutput();
            log('‚ïê‚ïê‚ïê ‚ö° QUICK CONNECT ‚ïê‚ïê‚ïê', 'info');
            
            if (!freighterApi) {
                log('‚ùå Freighter not available', 'error');
                return;
            }
            
            try {
                log('Step 1: Retrieving public key...', 'info');
                const publicKey = await freighterApi.getPublicKey();
                
                log('‚úÖ Connection successful!', 'success');
                log('', 'info');
                log('‚îÅ‚îÅ‚îÅ CONNECTION DETAILS ‚îÅ‚îÅ‚îÅ', 'success');
                log('Public Key:', 'info');
                log(publicKey, 'success');
                log('', 'info');
                
                // Check network
                const network = await freighterApi.getNetwork();
                log(`Network: ${network}`, network === 'TESTNET' ? 'success' : 'warning');
                
                if (network !== 'TESTNET') {
                    log('‚ö†Ô∏è Please switch to Testnet in Freighter settings', 'warning');
                }
                
                log('', 'info');
                log('‚úÖ Ready to use! You can now:', 'success');
                log('  ‚Ä¢ View predictions', 'info');
                log('  ‚Ä¢ Create predictions', 'info');
                log('  ‚Ä¢ Stake on outcomes', 'info');
                log('  ‚Ä¢ Sign transactions', 'info');
                
                // Store in session
                sessionStorage.setItem('wallet_address', publicKey);
                sessionStorage.setItem('wallet_network', network);
                sessionStorage.setItem('connection_type', 'quick');
                
                return publicKey;
                
            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        async function signedConnect() {
            clearOutput();
            log('‚ïê‚ïê‚ïê üîê SIGNED CONNECT ‚ïê‚ïê‚ïê', 'info');
            
            if (!freighterApi) {
                log('‚ùå Freighter not available', 'error');
                return;
            }
            
            try {
                log('Step 1: Retrieving public key...', 'info');
                const publicKey = await freighterApi.getPublicKey();
                log('‚úÖ Public key retrieved', 'success');
                log(publicKey, 'info');
                log('', 'info');
                
                log('Step 2: Requesting signature for verification...', 'info');
                log('‚è≥ Please approve the signature request in Freighter popup', 'warning');
                
                // Create a message to sign
                const timestamp = Date.now();
                const message = `TimeLock-Predictions Authentication
Public Key: ${publicKey}
Timestamp: ${timestamp}
Action: Login

This signature proves you own this wallet.`;
                
                log('', 'info');
                log('Message to sign:', 'info');
                log(message, 'info');
                log('', 'info');
                
                // Try to sign the message
                try {
                    const signature = await freighterApi.signAuthEntry(
                        message,
                        { accountToSign: publicKey }
                    );
                    
                    log('‚úÖ Signature received!', 'success');
                    log('', 'info');
                    log('‚îÅ‚îÅ‚îÅ VERIFIED CONNECTION DETAILS ‚îÅ‚îÅ‚îÅ', 'success');
                    log('Public Key:', 'info');
                    log(publicKey, 'success');
                    log('', 'info');
                    log('Signature:', 'info');
                    log(JSON.stringify(signature, null, 2), 'success');
                    log('', 'info');
                    log('Timestamp: ' + new Date(timestamp).toLocaleString(), 'info');
                    
                    // Check network
                    const network = await freighterApi.getNetwork();
                    log(`Network: ${network}`, network === 'TESTNET' ? 'success' : 'warning');
                    
                    if (network !== 'TESTNET') {
                        log('‚ö†Ô∏è Please switch to Testnet in Freighter settings', 'warning');
                    }
                    
                    log('', 'info');
                    log('‚úÖ Wallet ownership verified! You can now:', 'success');
                    log('  ‚Ä¢ All features unlocked', 'info');
                    log('  ‚Ä¢ Cryptographic proof of ownership', 'info');
                    log('  ‚Ä¢ Enhanced security', 'info');
                    
                    // Store in session
                    sessionStorage.setItem('wallet_address', publicKey);
                    sessionStorage.setItem('wallet_network', network);
                    sessionStorage.setItem('wallet_signature', JSON.stringify(signature));
                    sessionStorage.setItem('wallet_timestamp', timestamp);
                    sessionStorage.setItem('connection_type', 'signed');
                    
                    return {
                        publicKey,
                        signature,
                        timestamp,
                        verified: true
                    };
                    
                } catch (signError) {
                    if (signError.message.includes('User declined')) {
                        log('‚ùå Signature declined by user', 'error');
                        log('', 'info');
                        log('üí° TIP: You can still use Quick Connect for basic features', 'warning');
                    } else {
                        throw signError;
                    }
                }
                
            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // Show stored connection on load
        setTimeout(() => {
            const stored = sessionStorage.getItem('wallet_address');
            if (stored) {
                const type = sessionStorage.getItem('connection_type');
                const network = sessionStorage.getItem('wallet_network');
                log('', 'info');
                log('‚îÅ‚îÅ‚îÅ PREVIOUS SESSION FOUND ‚îÅ‚îÅ‚îÅ', 'warning');
                log(`Connection Type: ${type}`, 'info');
                log(`Address: ${stored}`, 'info');
                log(`Network: ${network}`, 'info');
                log('', 'info');
                log('üí° Click a button above to reconnect', 'info');
            }
        }, 1000);
    </script>
</body>
</html>
